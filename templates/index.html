<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MSU Expense Tracker</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <h1>MSU Expense Tracker</h1>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash">
          {% for msg in messages %}
            <div>{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- AI Insights -->
    <h2>AI Insights</h2>

    <!-- Normal: uses cache -->
    <form method="POST" action="/insights" style="margin-bottom:8px;">
    <button type="submit">Generate Insights</button>
    </form>

    <!-- Force refresh: bypasses cache -->
    <form method="POST" action="/insights" style="margin-bottom:12px;">
    <input type="hidden" name="force" value="1">
    <button type="submit">Refresh AI Insights</button>
    </form>

    {% if insights_text %}
    <div class="insights-box" style="white-space:pre-wrap; background:#f7f7f7; padding:12px; border-radius:8px; border:1px solid #ddd; margin-bottom:20px;">
        {{ insights_text }}
    </div>
    {% else %}
    <p style="color:#666;">Click “Generate Insights” to get personalized tips based on your recent spending.</p>
    {% endif %}


    <!-- Add Transaction -->
    <form method="POST">
      <label>Date: <input type="date" name="date" required></label>
      <label>Description: <input type="text" name="description" required></label>
      <label>Category: <input type="text" name="category" required></label>
      <label>Amount: <input type="number" name="amount" step="0.01" required></label>
      <button type="submit">Add Transaction</button>
    </form>

    <!-- Transactions Table -->
    <h2>Transactions</h2>
    <table>
      <tr>
        <th>Date</th>
        <th>Description</th>
        <th>Category</th>
        <th>Amount ($)</th>
        <th>Action</th>
      </tr>
      {% for t in transactions %}
      <tr>
        <td>{{ t.Date }}</td>
        <td>{{ t.Description }}</td>
        <td>{{ t.Category }}</td>
        <td>{{ '%.2f'|format(t.Amount) }}</td>
        <td>
          <form method="POST" action="/delete" style="display:inline;">
            <input type="hidden" name="id" value="{{ t.Id }}">
            <button type="submit">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </table>

    <!-- Charts -->
    {% if has_transactions %}
      <h2>Spending by Category</h2>
      <img src="/static/spending_by_category.png" alt="Spending Bar Chart">

      <h2>Spending Distribution</h2>
      <img src="/static/spending_pie.png" alt="Spending Pie Chart">
    {% endif %}

    <!-- Goals -->
    <h2>Set Spending Goal</h2>
    <form method="POST" action="/set-goal">
      <label>Month: <input type="month" name="goal_month" required></label>
      <label>Category: <input type="text" name="goal_category" required></label>
      <label>Goal Amount: <input type="number" name="goal_amount" step="0.01" required></label>
      <button type="submit">Set Goal</button>
    </form>

    <h2>Monthly Budget Comparison</h2>
    <table>
      <tr>
        <th>Month</th>
        <th>Category</th>
        <th>Goal ($)</th>
        <th>Spent ($)</th>
        <th>Remaining ($)</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
      {% for row in comparisons %}
      <tr>
        <td>{{ row.Month }}</td>
        <td>{{ row.Category }}</td>
        <td>{{ '%.2f'|format(row.Goal) }}</td>
        <td>{{ '%.2f'|format(row.Amount) }}</td>
        <td>{{ '%.2f'|format(row.Remaining) }}</td>
        <td style="color: {{ 'green' if row.Status == 'Under Budget' else 'red' }};">{{ row.Status }}</td>
        <td>
          <form method="POST" action="/delete-goal" style="display:inline;">
            <input type="hidden" name="goal_id" value="{{ row.GoalId }}">
            <button type="submit">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </table>

  </div>
</body>
</html>
